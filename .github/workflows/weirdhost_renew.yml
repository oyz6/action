name: Weirdhost Auto Login

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  login:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      
      - name: Install dependencies
        run: pip install -r scripts/Weirdhost/requirements.txt
      
      - name: Setup Proxy
        env:
          PROXY_NODE: ${{ secrets.PROXY_NODE }}
        run: |
          if [ -z "$PROXY_NODE" ]; then
            echo "⚠️ 未配置代理"
            exit 0
          fi
          
          # 下载 Xray
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip -d xray && chmod +x xray/xray
          
          # 生成配置 (简化版，支持 vless/vmess/trojan)
          python3 << 'EOF'
          import os, sys, json, base64
          from urllib.parse import parse_qs, unquote
          
          url = os.environ.get("PROXY_NODE", "").strip()
          if not url:
              sys.exit(0)
          
          config = {
              "inbounds": [{"port": 10808, "listen": "127.0.0.1", "protocol": "socks", "settings": {"udp": True}}],
              "outbounds": []
          }
          
          if url.startswith("vless://"):
              content = url[8:].split("#")[0]
              uuid, rest = content.split("@", 1)
              host_port, params_str = rest.split("?", 1) if "?" in rest else (rest, "")
              address, port = host_port.rsplit(":", 1)
              params = parse_qs(params_str)
              
              outbound = {
                  "protocol": "vless",
                  "settings": {"vnext": [{"address": address, "port": int(port), "users": [{"id": uuid, "encryption": "none"}]}]},
                  "streamSettings": {"network": params.get("type", ["tcp"])[0], "security": params.get("security", ["none"])[0]}
              }
              
              security = params.get("security", ["none"])[0]
              if security == "reality":
                  outbound["streamSettings"]["realitySettings"] = {
                      "serverName": params.get("sni", [address])[0],
                      "fingerprint": params.get("fp", ["chrome"])[0],
                      "publicKey": params.get("pbk", [""])[0]
                  }
                  if params.get("flow"):
                      outbound["settings"]["vnext"][0]["users"][0]["flow"] = params["flow"][0]
              elif security == "tls":
                  outbound["streamSettings"]["tlsSettings"] = {"serverName": params.get("sni", [address])[0]}
              
              if params.get("type", ["tcp"])[0] == "ws":
                  outbound["streamSettings"]["wsSettings"] = {"path": unquote(params.get("path", ["/"])[0])}
              
              config["outbounds"].append(outbound)
              print(f"✅ VLESS -> {address}:{port}")
          
          with open("xray_config.json", "w") as f:
              json.dump(config, f)
          EOF
          
          # 启动
          ./xray/xray run -c xray_config.json &
          sleep 3
          
          # 测试
          if curl -x socks5://127.0.0.1:10808 -s --max-time 10 https://api.ipify.org; then
            echo ""
            echo "✅ 代理连接成功"
            echo "PROXY_SOCKS5=socks5://127.0.0.1:10808" >> $GITHUB_ENV
          else
            echo "❌ 代理连接失败"
            exit 1
          fi
      
      - name: Run login
        env:
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          PROXY_SOCKS5: ${{ env.PROXY_SOCKS5 }}
        run: python scripts/Weirdhost/weirdhost_login.py
      
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weirdhost-debug
          path: debug_screenshots/
          retention-days: 3
