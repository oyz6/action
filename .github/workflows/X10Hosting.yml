# .github/workflows/x10-debug.yml
name: X10 Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
      - name: 启动代理
        env:
          HY2_URL: ${{ secrets.HY2_URL_JP }}
        run: |
          wget -q https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64 -O hysteria
          chmod +x hysteria
          
          URL="${HY2_URL#hysteria2://}"
          PASSWORD="${URL%%@*}"
          TEMP="${URL#*@}"
          SERVER="${TEMP%%\?*}"
          SNI=$(echo "$TEMP" | grep -oP 'sni=\K[^&]+' || echo "${SERVER%%:*}")
          
          cat > config.yaml << EOF
          server: $SERVER
          auth: $PASSWORD
          tls:
            sni: $SNI
            insecure: false
          http:
            listen: 127.0.0.1:8080
          EOF
          
          ./hysteria client -c config.yaml > hy.log 2>&1 &
          sleep 5
          
          # 显示代理 IP
          echo "=== 代理 IP ==="
          curl -s --proxy http://127.0.0.1:8080 https://api.ipify.org
          echo ""
          echo "=== 请确认这个 IP 和你登录时的 IP 一致 ==="

      - name: 测试 Cookie
        env:
          X10_COOKIES: ${{ secrets.X10_COOKIES }}
        run: |
          echo "=== Cookie 内容（部分隐藏）==="
          echo "$X10_COOKIES" | head -c 100
          echo "..."
          echo ""
          echo "=== Cookie 长度 ==="
          echo "${#X10_COOKIES} 字符"
          echo ""
          
          # 检查 Cookie 格式
          echo "=== Cookie 检查 ==="
          if echo "$X10_COOKIES" | grep -q "XSRF-TOKEN"; then
            echo "✅ 包含 XSRF-TOKEN"
          else
            echo "❌ 缺少 XSRF-TOKEN"
          fi
          
          if echo "$X10_COOKIES" | grep -q "x10hosting_session"; then
            echo "✅ 包含 x10hosting_session"
          else
            echo "❌ 缺少 x10hosting_session"
          fi

      - name: 访问面板（详细输出）
        env:
          X10_COOKIES: ${{ secrets.X10_COOKIES }}
        run: |
          echo "=== 发送请求 ==="
          
          # 保存完整响应
          curl -v --proxy http://127.0.0.1:8080 \
            -H "Cookie: $X10_COOKIES" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            -L \
            -o response.html \
            "https://x10hosting.com/panel/services/175344" 2>&1 | head -50
          
          echo ""
          echo "=== 响应页面标题 ==="
          grep -o '<title>[^<]*</title>' response.html || echo "无标题"
          
          echo ""
          echo "=== 页面关键词检测 ==="
          echo -n "login/sign in: "; grep -ci 'login\|sign.in' response.html || echo "0"
          echo -n "captcha: "; grep -ci 'captcha\|recaptcha' response.html || echo "0"
          echo -n "dashboard: "; grep -ci 'dashboard\|panel\|service' response.html || echo "0"
          
          echo ""
          echo "=== 页面前 2000 字符 ==="
          head -c 2000 response.html
          
          echo ""
          echo ""
          echo "=== 检查是否有表单 ==="
          grep -o '<form[^>]*>' response.html | head -5

      - name: 测试首页
        env:
          X10_COOKIES: ${{ secrets.X10_COOKIES }}
        run: |
          echo "=== 测试访问首页 ==="
          curl -s --proxy http://127.0.0.1:8080 \
            -H "Cookie: $X10_COOKIES" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0" \
            -o home.html \
            -w "HTTP: %{http_code}, 重定向: %{redirect_url}\n" \
            "https://x10hosting.com/panel"
          
          echo "=== 首页标题 ==="
          grep -o '<title>[^<]*</title>' home.html || echo "无"
