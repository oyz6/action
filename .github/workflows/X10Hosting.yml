# .github/workflows/x10-keepalive.yml
name: X10 Hosting Keep Alive

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘

jobs:
  keepalive:
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½ Hysteria2
        run: |
          wget -q https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64 -O hysteria
          chmod +x hysteria

      - name: é…ç½® Hysteria2
        env:
          HY2_URL: ${{ secrets.HY2_URL_JP }}
        run: |
          # è§£æ hysteria2:// URL
          URL_BODY="${HY2_URL#hysteria2://}"
          URL_BODY="${URL_BODY%%#*}"
          PASSWORD="${URL_BODY%%@*}"
          SERVER_PART="${URL_BODY#*@}"
          SERVER="${SERVER_PART%%\?*}"
          PARAMS="${SERVER_PART#*\?}"
          
          get_param() { 
            echo "$PARAMS" | tr '&' '\n' | grep "^$1=" | cut -d'=' -f2
          }
          
          SNI=$(get_param "sni")
          INSECURE=$(get_param "insecure")
          
          [ -z "$SNI" ] && SNI="${SERVER%%:*}"
          [ "$INSECURE" = "1" ] && INSECURE="true" || INSECURE="false"
          
          cat > hy2-config.yaml << EOF
          server: ${SERVER}
          auth: ${PASSWORD}
          tls:
            sni: ${SNI}
            insecure: ${INSECURE}
          socks5:
            listen: 127.0.0.1:1080
          http:
            listen: 127.0.0.1:8080
          EOF
          
          echo "âœ… Hysteria2 é…ç½®å®Œæˆ"
          cat hy2-config.yaml

      - name: å¯åŠ¨ä»£ç†
        run: |
          ./hysteria client -c hy2-config.yaml > hysteria.log 2>&1 &
          sleep 5
          
          # éªŒè¯ä»£ç†æ˜¯å¦å·¥ä½œ
          PROXY_IP=$(curl -s --proxy socks5://127.0.0.1:1080 https://api.ipify.org 2>/dev/null || echo "failed")
          if [ "$PROXY_IP" = "failed" ]; then
            echo "âŒ ä»£ç†å¯åŠ¨å¤±è´¥"
            cat hysteria.log
            exit 1
          fi
          echo "âœ… ä»£ç†å·²å¯åŠ¨ï¼ŒIP: $PROXY_IP"

      - name: è®¿é—® x10hosting é¢æ¿
        id: visit
        env:
          X10_COOKIES: ${{ secrets.X10_COOKIES }}
        run: |
          # åˆ›å»º cookie æ–‡ä»¶
          echo "$X10_COOKIES" | tr ';' '\n' | while read cookie; do
            cookie=$(echo "$cookie" | xargs)  # trim
            if [ -n "$cookie" ]; then
              name="${cookie%%=*}"
              value="${cookie#*=}"
              echo -e ".x10hosting.com\tTRUE\t/\tTRUE\t0\t$name\t$value" >> cookies.txt
            fi
          done
          
          # é€šè¿‡ä»£ç†è®¿é—®é¢æ¿
          echo "ğŸ”„ æ­£åœ¨è®¿é—®é¢æ¿..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --proxy socks5://127.0.0.1:1080 \
            --cookie cookies.txt \
            --cookie-jar new_cookies.txt \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: en-US,en;q=0.5" \
            -L \
            "https://x10hosting.com/panel/services/175344" \
            2>&1)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ "$HTTP_CODE" = "200" ]; then
            if echo "$BODY" | grep -qi "captcha\|recaptcha\|verify"; then
              echo "âš ï¸ é‡åˆ°éªŒè¯ç ï¼ŒCookie å¯èƒ½å·²å¤±æ•ˆ"
              echo "needs_recaptcha=true" >> $GITHUB_OUTPUT
            elif echo "$BODY" | grep -qi "login\|sign.in"; then
              echo "âŒ éœ€è¦é‡æ–°ç™»å½•ï¼ŒCookie å·²å¤±æ•ˆ"
              exit 1
            else
              echo "âœ… æˆåŠŸè®¿é—®é¢æ¿"
              echo "needs_recaptcha=false" >> $GITHUB_OUTPUT
            fi
          elif [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "301" ]; then
            echo "âš ï¸ é‡å®šå‘ï¼Œå¯èƒ½éœ€è¦ç™»å½•"
          else
            echo "âŒ è®¿é—®å¤±è´¥: HTTP $HTTP_CODE"
            exit 1
          fi
          
          # æå–æ–° Cookie
          NEW_COOKIES=""
          if [ -f new_cookies.txt ]; then
            while read line; do
              if [[ ! "$line" =~ ^# ]] && [ -n "$line" ]; then
                name=$(echo "$line" | awk '{print $6}')
                value=$(echo "$line" | awk '{print $7}')
                if [ -n "$name" ] && [ -n "$value" ]; then
                  if [ -n "$NEW_COOKIES" ]; then
                    NEW_COOKIES="${NEW_COOKIES}; "
                  fi
                  NEW_COOKIES="${NEW_COOKIES}${name}=${value}"
                fi
              fi
            done < new_cookies.txt
          fi
          
          if [ -n "$NEW_COOKIES" ]; then
            echo "ğŸ“ è·å–åˆ°æ–° Cookie"
            # ä½¿ç”¨ base64 ç¼–ç é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            echo "new_cookies=$(echo -n "$NEW_COOKIES" | base64 -w 0)" >> $GITHUB_OUTPUT
          fi

      - name: æ›´æ–° Cookie Secrets
        if: steps.visit.outputs.new_cookies != ''
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
          NEW_COOKIES_B64: ${{ steps.visit.outputs.new_cookies }}
        run: |
          # è§£ç  Cookie
          NEW_COOKIES=$(echo "$NEW_COOKIES_B64" | base64 -d)
          
          # è·å–ä»“åº“å…¬é’¥
          echo "ğŸ”‘ è·å–ä»“åº“å…¬é’¥..."
          KEY_RESPONSE=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key")
          
          KEY_ID=$(echo "$KEY_RESPONSE" | jq -r '.key_id')
          PUBLIC_KEY=$(echo "$KEY_RESPONSE" | jq -r '.key')
          
          if [ "$KEY_ID" = "null" ] || [ -z "$KEY_ID" ]; then
            echo "âŒ è·å–å…¬é’¥å¤±è´¥"
            echo "$KEY_RESPONSE"
            exit 1
          fi
          
          # å®‰è£…åŠ å¯†å·¥å…·
          pip install pynacl -q
          
          # åŠ å¯† Secret
          ENCRYPTED=$(python3 << EOF
          import base64
          from nacl import encoding, public
          
          def encrypt(public_key: str, secret_value: str) -> str:
              public_key = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
              sealed_box = public.SealedBox(public_key)
              encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(encrypted).decode("utf-8")
          
          print(encrypt("$PUBLIC_KEY", """$NEW_COOKIES"""))
          EOF
          )
          
          # æ›´æ–° Secret
          echo "ğŸ”„ æ›´æ–° X10_COOKIES..."
          UPDATE_RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/secrets/X10_COOKIES" \
            -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}")
          
          echo "âœ… Cookie å·²æ›´æ–°"

      - name: æ¸…ç†
        if: always()
        run: |
          pkill -f hysteria || true
          rm -f cookies.txt new_cookies.txt hy2-config.yaml hysteria.log
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"
